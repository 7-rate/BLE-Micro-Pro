# 自作キーボードキットを無線化する

BLE Micro Proを導入する手順はいくつかありますが、初めての場合は[BLE Micro Pro Web Configurator](https://sekigon-gonnoc.github.io/BLE-Micro-Pro-WebConfigurator/)を使った方法がおすすめです。

- [ハードウェアの準備](#ハードウェアの準備)
- [BLE Micro Pro Web Configuratorを使う](#ble-micro-pro-web-configuratorを使う)
  - [事前準備](#事前準備)
  - [キーボードを選ぶ](#キーボードを選ぶ)
  - [ファームウェアのアップデート](#ファームウェアのアップデート)
  - [設定ファイルの書き込み](#設定ファイルの書き込み)
  - [キーマップの書き込み](#キーマップの書き込み)
- [BLE Micro Pro上のファイルを直接操作する](#ble-micro-pro上のファイルを直接操作する)
  - [UF2ファイルでファームウェアをアップデートする](#uf2ファイルでファームウェアをアップデートする)
    - [ブートローダの起動](#ブートローダの起動)
    - [ファームウェアの書き込み](#ファームウェアの書き込み)
  - [設定ファイルの書き込み](#設定ファイルの書き込み-1)
  - [設定ファイルの削除](#設定ファイルの削除)

## ハードウェアの準備

- Pro Microの代わりにBLE Micro Proを取り付ける
  - コンスルーに合わせた穴径となっているためハンダ付けは必要ありません。

- 電源を用意する
  - 導入の段階ではUSBケーブルで接続するので必須ではありませんが、無線運用するときには電池などから電源供給する必要があります。
  - キーボードキットに用意されているオプションや、遊舎工房、BOOTHで販売している電池基板を使ってください。  
    - 電池基板とBLE Micro Proの接続にはコンスルー・ピンヘッダや銅線を使ってください。
  - 電源を自分で作る場合には[デザインガイド](design_guide.md#電源)を参照してください。


## BLE Micro Pro Web Configuratorを使う

Google ChromeからBLE Micro Pro Web Configuratorにアクセスするとブラウザからファームウェアのアップデートや各種設定ができます。

### 事前準備

Google Chromeのアドレスバーに `chrome://flags#enable-experimental-web-platform-features`を入力して、**Experimental Web Platform featuresをEnabled**にします。

[Web Configuraor](https://sekigon-gonnoc.github.io/BLE-Micro-Pro-WebConfigurator/)にアクセスしたとき警告が出なければ設定完了です。

### キーボードを選ぶ

`ナビゲーション付きでセットアップを開始する`ボタンを押すとキーボードの選択画面が表示されます。
リストから無線化したいキーボードを選んでください。

ErgoDashやRunner3680のようにキー配置が複数選べる場合はレイアウトが選択できるので、自分が作ったキーボードのレイアウトを選択してください。

無線化したいキーボードがリストにない場合には、[キーボードの設定を生成して](edit_config_file.md)、ここでは`ble_micro_pro`または`ble_micro_pro_split`を選択してください。

このページでは2つのオプションが選択できます。

- Disable Mass Storage Class
  - BLE Micro Proにファームウェアを書き込むとパソコンにUSBケーブルで接続したときに大容量記憶デバイスとして認識されます。セキュリティの都合などで、大容量記憶デバイスとして認識されると困る場合にはこのオプションにチェックを入れることで機能を無効化できます。

- Use with LPME-IO（分割型のみ）
  - 分割型キーボードを無線化するときにBLE Micro Proを2台使った完全無線化をするのではなく、BLE Micro ProとLPME-IOを組み合わせた部分無線化をする場合にはこのオプションにチェックを入れてください。  
  - **LPME-IOを使用するにはキーボードの改造が必要な場合があります**

構成を選択し終わったら`Next`ボタンを押すと次の手順に進みます。

### ファームウェアのアップデート

BLE Micro Proにはブートローダとアプリケーションという2種類のファームウェアを書き込みます。

2つのファームウェアのバージョンは`<major>.<minor>.<revision>`の3つの数字の組み合わせで表されていて、ブートローダとアプリケーションのメジャーバージョンとマイナーバージョンは一致させる必要があります。

特別な事情がない限りは両方ともデフォルトで選択されている最新版を利用してください。

また、大容量記憶デバイスの無効化オプションはブートローダとアプリケーションのそれぞれで設定でき、初期設定は最初の画面で選んだとおりになっています。

アップデートしたいBLE Micro ProをUSBケーブルで接続したら、`Update`ボタンを押してください。
[事前準備](#事前準備)が終わっていれば、ブラウザの左上からCOMポートの選択画面が表示されます。
BLE Micro ProのCOMポートを選択したら`接続`ボタンを押してください。
どのポートがBLE Micro Proのものかわからない場合は、接続する前後で比較してみてください。

ブートローダが起動したという表示が出た場合はもう一度`Update`ボタンを押します。

アップデートが始まると進捗状況が表示されます。進捗が100%になり、アップデートに成功したという表示が出たら`Next`ボタンを押して次の手順に進みます。

繰り返しになりますが、ブートローダとアプリケーションをそれぞれアップデートしてください。

### 設定ファイルの書き込み

設定ファイルの書き込み画面でもキーボードの選択リストが表示されます。
ナビゲーション付きでセットアップを開始した場合は最初に選択したキーボードとレイアウトが選択されているため、ここで選択し直す必要はありません。

最初にキーボードを選択するときに`ble_micro_pro`を選択した場合は、ここで`upload your own`を選択してください。

ここでもいくつかオプションを設定できます

- Use With LPME-IO（分割型のみ）
  - 前述の設定と同様です。デフォルトでは最初の画面で選んだ設定が引き継がれています。

- Is Slave（分割型のみ）
  - 分割型の場合、2つのBLE Micro ProにMaster/Slaveという役割が割り振られます。ナビゲーション付きでセットアップを開始した場合は手順に応じて自動的に選択されるため、変更する必要はありません。

- Is Left（分割型のみ）
  - いま設定しているBLE Micro Proを左手に取り付ける場合にはチェックを入れてください。

- Show keymap.json using JP_XX
  - キーマップ設定の表示を、OSの設定がJISキーボードとなっているときに適した表示にします。

- Debounce
  - キー入力のチャタリング除去のパラメータです。デフォルトは1で、チャタリングがひどい場合にはチャタリングが無くなるまで1ずつ増やしてみてください。

- Connection inteval(Peripheral)
  - 通信間隔の設定です。短くすると入力のラグが減る一方で、電力消費が増加します。
    - 一体型キーボード、または分割型キーボードのMasterを設定している場合はPCとの通信間隔を設定します。
    - 分割型キーボードのSlaveを設定している場合はMasterとの通信間隔を設定します。後述のMaster側の設定と合わせてください。
  
- Connection inteval(Central)（分割型Masterのみ）
  - 分割型キーボードのSlaverとの通信間隔を設定します。前述のSlave側の設定と合わせてください。

オプションを設定したら`Update`ボタンを押すとシリアルポートの選択が表示され、BLE Micro Proを接続したシリアルポートを選択するとアップデートが始まります。
リストから`upload your own`を選択した場合はここでファイルの選択画面が表示されるため、用意したコンフィグファイルを選んでください。
設定が成功したら`Next`ボタンを押して次の手順に進んでください。

一体型キーボード、またはLPME-IOを使った設定をしている場合はこのままキーマップの書き換えに進みます。

分割型キーボードを完全無線化する場合はSlave側のBLE Micro Proに繋ぎ変えて同様の手順を繰り返してください。

すべてのBLE Micro Proの設定が完了したら、Master側のBLE Micro Proに再度繋ぎ変えて、キーマップの書き換えに進んでください。

### キーマップの書き込み

キーマップの書き換えにはBLE Micro Pro用の変更を加えたQMK Configuratorを使います。

- `CONNECT BY SERIAL`ボタンを押してシリアルポートを開く。
  - 一度キーマップを設定済みのBLE Micro Proに接続した場合、自動的にBLE Micro Proから現在のキーマップがロードされます。
- はじめて設定する場合、キーボードリストから設定したいキーボードを選択してキーマップを設定する。
  - キーボードリストにキーボードがない場合、`CONNECT BY SERIAL`の右側にあるボタンを押してキーマップをロードするとconfig.jsonの中身に応じた暫定のキー配置でキーマップが表示されます。他のキーボードのようにレイアウトしたい場合はQMK Configuratorにプルリクエストを出してください。
- `CONNECT BY SERIAL`の左側のボタンを押して設定したキーマップをキーボードに反映する。
- 試しに入力してみて問題なければ`SAVE KEYMAP`ボタンを押してキーボードに保存する。

以上で設定は完了です。QMKの設定を変えたり、カスタムキーコードを追加したりしたい場合は[ファームウェアをビルドする](build_firmware.md)に進んでください。

## BLE Micro Pro上のファイルを直接操作する

### UF2ファイルでファームウェアをアップデートする

#### ブートローダの起動

- キーボードのリセットボタンを押しながらUSB接続するとブートローダが起動します

- すでにキーボードとして動作する場合には[CLI](cli.md)からdfuコマンドを送信することでも起動できます  

- v0.4.0以降のQMK for BMPを使用している場合、起動中にリセットスイッチ長押しでも起動します

#### ファームウェアの書き込み

拡張子が`.uf2`のファイルを使って書き込みます  
**[ブートローダーv0.2.0, v0.3.0からアップデートする場合はv0.2.1, v0.3.1を経由してください](https://github.com/sekigon-gonnoc/BLE-Micro-Pro/issues/10)**  
nrfutilを使う場合は経由せずに直接アップデートできます

- BLE Micro Proがマスストレージデバイスとして認識され、中に`INFO_UF2.TXT`があることを確認してください。このファイルがない場合、ブートローダの起動に失敗しているので再起動してください
  - v0.4.0以降、ブートローダ起動時のボリュームラベルはBLEMICROPRO、キーボード起動時のボリュームラベルは設定したキーボード名になるので、これで判別することもできます

- アップデートしたいuf2ファイルをコピーするとアップデートが始まります。アップデート中はケーブルを外さないでください

- アップデートが完了すると自動でアンマウントされます

- ブートローダをアップデートした場合、`INFO_UF2.TXT`を開いてアップデート完了を確認してください

- アプリケーションのアップデートの場合は`VERSION.TXT`を開いてアップデート完了を確認してください

### 設定ファイルの書き込み

BLE Micro Proがアプリケーションを起動している状態で設定ファイルをコピーすると自動的に書き込みが始まります。
BLE Micro Pro上のファイルを直接編集することもできますが、バックアップの意味も兼ねて一度PC上にコピーしてから編集、転送することを推奨します。

コンフィグ用ファイル（CONFIG.JSN）は[BLE Micro Proのリポジトリから探す](https://github.com/sekigon-gonnoc/BLE-Micro-Pro/tree/master/AboutDefaultFirmware/keyboards)か、キーボードの作者が提供しているものを使うか、[自分で作成する](edit_config_file.md)か、いずれかの方法で用意してください。
なお、書き込むときにファイル名をCONFIG.JSNにリネームする必要はありません。再起動後に自動でリネームされます。

キーマップ用ファイル（KEYMAP.JSN）はQMK Configuratorを使って生成するか、テキストエディタなどで編集してください。
書き方は[こちら](edit_keymap_file.md)

その他に、TAPPING TERMの調整、ロータリーエンコーダの設定ができます。

### 設定ファイルの削除

PCから見えているファイルを削除してもBLE Micro Proを再起動すると復活します。完全に削除してデフォルトに戻したい場合は[CLI](cli.md)からremoveコマンドを使ってください。
